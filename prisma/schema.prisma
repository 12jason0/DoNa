generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Payment {
  id          String        @id @default(cuid()) // ê²°ì œ IDëŠ” ë³´ì•ˆìƒ UUID(cuid) ì¶”ì²œ
  userId      Int           @map("user_id")
  
  // ì£¼ë¬¸ ì •ë³´
  orderId     String        @unique @map("order_id") // ìš°ë¦¬ê°€ ìƒì„±í•œ ì£¼ë¬¸ë²ˆí˜¸ (ì˜ˆ: ORD_2024...)
  orderName   String        @map("order_name")       // ìƒí’ˆëª… (ì˜ˆ: "AI í”„ë¦¬ë¯¸ì—„ êµ¬ë…", "ì¿ í° 5ê°œ")
  amount      Int                                    // ê²°ì œ ê¸ˆì•¡
  
  // ê²°ì œ ìƒíƒœ ë° PGì‚¬ ì •ë³´
  status      PaymentStatus @default(READY)
  paymentKey  String?       @map("payment_key")      // í† ìŠ¤ ë“± PGì‚¬ì—ì„œ ì£¼ëŠ” ê²°ì œ í‚¤
  method      String?                                // ì¹´ë“œ, ê³„ì¢Œì´ì²´ ë“±
  
  // ë‚ ì§œ
  requestedAt DateTime      @default(now()) @map("requested_at") // ê²°ì œ ìš”ì²­ ì‹œê°
  approvedAt  DateTime?     @map("approved_at")      // ê²°ì œ ìŠ¹ì¸ ì‹œê°

  // ê´€ê³„
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([orderId])
  @@map("payments")
}

model User {
  id                 Int                 @id @default(autoincrement())
  email              String?             @unique @db.VarChar(191)
  password           String?             @db.VarChar(255)
  username           String              @map("nickname") @db.VarChar(50)
  profileImageUrl    String?
  socialId           String?             @db.VarChar(255)
  provider           String              @default("local") @db.VarChar(20)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  mbti               String?             @db.VarChar(20)
  age                Int?
  couponCount        Int                 @default(0)
  gender             String?             @db.VarChar(10)
  lastActiveAt       DateTime?
  level              Int                 @default(1)
  location           String?             @db.VarChar(100)
  preferredTags      String[]
  ageRange           String?             @db.VarChar(20)
  birthday           DateTime?
  phone              String?             @db.VarChar(30)
  completedCourses   CompletedCourse[]
  completedEscapes   CompletedEscape[]
  bookings           Booking[]
  courses            Course[]
  missionSubmissions MissionSubmission[]
  pushTokens         PushToken?
  reviews            Review[]
  userBadges         UserBadge[]
  checkins           UserCheckin[]
  UserCollage        UserCollage[]
  userFavorites      UserFavorite[]
  interactions       UserInteraction[]
  userPreference     UserPreference?
  rewards            UserReward[]
  userStoryProgress  UserStoryProgress[]
  savedCourses       SavedCourse[]

  // [ì¶”ê°€] êµ¬ë… ì •ë³´ ğŸ‘‘
  subscriptionTier     SubscriptionTier  @default(FREE) @map("subscription_tier")
  subscriptionExpiresAt DateTime?        @map("subscription_expires_at")
  isAutoRenewal        Boolean           @default(false) @map("is_auto_renewal")

  // ê²°ì œ ë‚´ì—­
  payments             Payment[]

  @@index([provider, socialId])
  @@map("users")
}

model UserReward {
  id        Int          @id @default(autoincrement())
  amount    Int
  createdAt DateTime     @default(now())
  userId    Int
  type      RewardType
  unit      RewardUnit
  user      User         @relation(fields: [userId], references: [id])
  // ì¥ì†Œ ê¸°ë°˜ ë³´ìƒ(ì˜ˆ: escape ì¥ì†Œ í´ë¦¬ì–´ ë³´ìƒ) ì¶”ì ìš©
  placeId   Int?
  place     PlaceOption? @relation(fields: [placeId], references: [id])

  // ê°™ì€ ìœ í˜•(type)ì˜ ì¥ì†Œ(placeId) ë³´ìƒì€ ì‚¬ìš©ìë‹¹ 1íšŒë§Œ í—ˆìš©
  @@unique([userId, placeId, type])
  @@map("user_rewards")
}

model UserCheckin {
  id        Int      @id @default(autoincrement())
  date      DateTime
  rewarded  Boolean  @default(false)
  createdAt DateTime @default(now())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])

  @@map("user_checkins")
}

model UserInteraction {
  id        Int      @id @default(autoincrement())
  userId    Int
  courseId  Int
  action    String
  createdAt DateTime @default(now())
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_interactions")
}

model UserPreference {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique @map("user_id")
  preferences Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model PushToken {
  id         String   @id @default(cuid())
  userId     Int      @unique
  token      String
  platform   String   @default("expo")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  subscribed Boolean  @default(true)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_tokens")
}

model Course {
  id                   Int                  @id @default(autoincrement())
  userId               Int?
  title                String               @db.VarChar(100)
  description          String?
  imageUrl             String?              @db.VarChar(255)
  region               String?              @db.VarChar(50)
  duration             String?              @db.VarChar(45)
  concept              String?              @db.VarChar(45)
  tags                 Json? // AI ì¶”ì²œìš© íƒœê·¸: { concept, mood, target, time, budget(ì˜ˆì‚°), theme }
  isPopular            Boolean              @default(false)
  rating               Float                @default(0.0)
  current_participants Int                  @default(0)
  max_participants     Int                  @default(0)
  view_count           Int                  @default(0)
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt
  completedCourses     CompletedCourse[]
  // ì½”ìŠ¤ ìƒì„¸(ë¶€ê°€ ì •ë³´) 1:1
  courseDetail         CourseDetail?
  courseTags    CourseTagRelation[]
  benefits             Benefit[]
  bookings             Booking[]
  courseNotices        CourseNotice[]
  coursePlaces         CoursePlace[]
  user                 User?                @relation(fields: [userId], references: [id], onDelete: Cascade)
  highlights           Highlight[]
  reviews              Review[]
  userFavorites        UserFavorite[]
  interactions         UserInteraction[]
  savedUsers           SavedCourse[]

  //ëŒ€í‘œë‹˜ í”½
  is_editor_pick Boolean @default(false)

  // ì¸ë„¤ì¼ìš© ì§§ì€ ì¹´í”¼ (ì¹´ë“œ UI ìƒë‹¨ì— ë„ìš¸ ë¬¸êµ¬)
  // ì˜ˆ: "ì¸ë…€ê°€ 200% ê°ë™í•˜ëŠ”", "ë¹„ ì˜¤ëŠ” ë‚ ë„ ë½€ì†¡í•˜ê²Œ"
  sub_title          String?  @map("sub_title") @db.VarChar(100)
  // ì½”ìŠ¤ì˜ í•µì‹¬ ìƒí™© (ë©”ì¸ í™”ë©´ íë ˆì´ì…˜ ë° í•„í„°ë§ìš©)
  // ì˜ˆ: "FIRST_DATE"(ì²«ë§Œë‚¨), "ANNIVERSARY"(ê¸°ë…ì¼), "RAINY_DAY"(ë¹„ì˜¤ëŠ”ë‚ ), "AFTER_WORK"(í‡´ê·¼í›„)
  // Enumìœ¼ë¡œ ê´€ë¦¬í•´ë„ ì¢‹ì§€ë§Œ, ìœ ì—°í•˜ê²Œ Stringìœ¼ë¡œ ì‹œì‘í•´ë„ ë©ë‹ˆë‹¤.
  target_situation   String?  @map("target_situation") @db.VarChar(50)

  // ì½”ìŠ¤ ê³µê°œ ì—¬ë¶€ë¶€
  isPublic    Boolean  @default(true)
  // [ì¶”ê°€] ì½”ìŠ¤ ë“±ê¸‰ (ë¬´ë£Œ/ë² ì´ì§/í”„ë¦¬ë¯¸ì—„)
  grade              CourseGrade @default(FREE)

  @@index([concept])
  @@index([region])
  @@index([title])
  @@map("courses")
}

// ì½”ìŠ¤ ë¶€ê°€ ì •ë³´(ì¶”ì²œ ì‹œê°„/ê³„ì ˆ/ìœ í˜•/êµí†µ/ì£¼ì°¨ ë“±)
model CourseDetail {
  id                     Int     @id @default(autoincrement())
  course_id              Int     @unique
  recommended_start_time String? @db.VarChar(100)
  season                 String? @db.VarChar(50)
  course_type            String? @db.VarChar(50)
  transportation         String? @db.VarChar(50)
  course                 Course  @relation(fields: [course_id], references: [id], onDelete: Cascade)

  @@map("course_details")
}

model Place {
  id                   Int              @id @default(autoincrement())
  name                 String           @db.VarChar(255)
  address              String?          @db.VarChar(500)
  description          String?
  category             String?          @db.VarChar(100)
  avg_cost_range       String?          @db.VarChar(100)
  opening_hours        String?          @db.VarChar(200)
  phone                String?          @db.VarChar(50)
  website              String?          @db.VarChar(500)
  parking_available    Boolean?         @default(false)
  reservation_required Boolean?         @default(false)
  latitude             Float?
  longitude            Float?
  imageUrl             String?          @db.VarChar(500)
  created_at           DateTime         @default(now())
  updated_at           DateTime         @updatedAt
  // ì½”ìŠ¤ì™€ ë™ì¼í•˜ê²Œ JSON í˜•ì‹ìœ¼ë¡œ ë³´ê´€ (ë°°ì—´/ê°ì²´ ëª¨ë‘ í—ˆìš©)
  tags                 Json? // AI ì¶”ì²œìš© íƒœê·¸: { concept, mood, target, time, budget(ì˜ˆì‚°), theme }
  coursePlaces         CoursePlace[]
  closed_days          PlaceClosedDay[]

  @@index([name])
  @@index([address])
  @@map("places")
}

model CourseTag {
  id                 Int                  @id @default(autoincrement())
  name               String               @unique @db.VarChar(100)
  createdAt          DateTime             @default(now())
  courses   CourseTagRelation[]

  @@map("course_tags")
}

model Story {
  id                     Int                 @id @default(autoincrement())
  title                  String              @db.VarChar(255)
  synopsis               String?
  region                 String?             @db.VarChar(100)
  estimated_duration_min Int?
  price                  String?             @db.VarChar(100)
  reward_badge_id        Int?
  is_active              Boolean             @default(true)
  created_at             DateTime            @default(now())
  updated_at             DateTime            @updatedAt
  imageUrl               String?
  level                  Int?                @default(1)
  epilogue_text          String?
  stationName            String?             @db.VarChar(100)
  stationLat             Float?
  stationLng             Float?
  scenario               String?
  completedEscapes       CompletedEscape[]
  placeDialogues         PlaceDialogue[]
  CollageTemplate        CollageTemplate[]
  reward_badge           Badge?              @relation(fields: [reward_badge_id], references: [id])
  userstoryprogress      UserStoryProgress[]
  ui                     StoryUI?

  @@map("stories")
}

/// UI/ì—°ì¶œ ì„¤ì •ì„ ìŠ¤í† ë¦¬ ë‹¨ìœ„ë¡œ ë³´ê´€ (ì—”ì§„ ì „í™˜/í…Œë§ˆ/í”Œë¡œìš°)
model StoryUI {
  id          Int      @id @default(autoincrement())
  storyId     Int      @unique
  engine_key  String   @db.VarChar(50) // letter | webtoon | visual_novel ...
  tokens_json Json? // ìƒ‰/í°íŠ¸/ê³¡ë¥  ë“± í…Œë§ˆ í† í°
  flow_json   Json? // ì—°ì¶œ/ì”¬/ë©”ì‹œì§€ ì‹œí€€ìŠ¤(ì°¸ì¡° id ê¸°ë°˜)
  version     Int      @default(1)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  story       Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([engine_key])
  @@map("story_ui")
}

model PlaceOption {
  id             Int             @id @default(autoincrement())
  storyId        Int
  name           String
  address        String?
  latitude       Float?
  longitude      Float?
  description    String?
  imageUrl       String?
  category       String?
  signature      String?
  placeDialogues PlaceDialogue[]
  missions       PlaceMission[]
  stories        PlaceStory[]
  theme          PlaceTheme?

  // UserRewardì™€ì˜ ì—­ê´€ê³„(ì¥ì†Œ ê¸°ë°˜ ë³´ìƒ ê¸°ë¡)
  userRewards UserReward[]
}

model PlaceDialogue {
  id          Int          @id @default(autoincrement())
  storyId     Int
  placeId     Int?
  order       Int          @default(1)
  type        String       @default("main")
  speaker     String?
  message     String
  imageUrl    String?
  createdAt   DateTime     @default(now())
  isLetter    Boolean      @default(false)
  letterIndex Int?
  role        SpeakerRole  @default(npc)
  place       PlaceOption? @relation(fields: [placeId], references: [id])
  story       Story        @relation(fields: [storyId], references: [id])
}

model PlaceMission {
  id             Int          @id @default(autoincrement())
  placeId        Int
  missionNumber  Int
  missionPayload Json?
  description    String?
  answer         String?
  hint           String?
  question       String?
  missionType    MissionType
  place          PlaceOption  @relation(fields: [placeId], references: [id])
  placeStories   PlaceStory[]
}

model PlaceStory {
  id          Int           @id @default(autoincrement())
  placeId     Int
  order       Int
  speaker     String?
  dialogue    String?
  narration   String?
  nextTrigger String?
  missionId   Int?
  mission     PlaceMission? @relation(fields: [missionId], references: [id])
  place       PlaceOption   @relation(fields: [placeId], references: [id])
}

model UserCollage {
  id           Int              @id @default(autoincrement())
  userId       Int
  templateId   Int?
  collageUrl   String           @map("collage_url")
  thumbnailUrl String?          @map("thumbnail_url")
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")
  storyId      Int?
  template     CollageTemplate? @relation(fields: [templateId], references: [id])
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_collages")
}

model CollageTemplate {
  id          Int           @id @default(autoincrement())
  name        String        @db.VarChar(50)
  imageUrl    String?       @map("image_url")
  framesJson  Json?         @map("frames_json")
  isPublic    Boolean       @default(true) @map("is_public")
  createdAt   DateTime      @default(now()) @map("created_at")
  storyId     Int?
  story       Story?        @relation(fields: [storyId], references: [id], onDelete: Cascade)
  userCollage UserCollage[]

  @@unique([storyId])
  @@map("collage_templates")
}

model Badge {
  id          Int         @id @default(autoincrement())
  name        String      @unique @db.VarChar(100)
  description String?
  image_url   String?     @db.VarChar(500)
  stories     Story[]
  userBadges  UserBadge[]

  @@map("badges")
}

model CompletedCourse {
  id          Int      @id @default(autoincrement())
  userId      Int
  courseId    Int
  completedAt DateTime @default(now())
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("CompletedCourses")
}

model Review {
  id        Int      @id @default(autoincrement())
  userId    Int
  courseId  Int
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("reviews")
}

model Booking {
  id           Int      @id @default(autoincrement())
  user_id      Int
  course_title String   @db.VarChar(255)
  booking_date DateTime @db.Date
  status       String   @db.VarChar(45)
  price        String   @db.VarChar(50)
  participants Int
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  course_id    Int
  course       Course   @relation(fields: [course_id], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("bookings")
}

model UserFavorite {
  id         Int      @id @default(autoincrement())
  user_id    Int
  course_id  Int
  created_at DateTime @default(now())
  course     Course   @relation(fields: [course_id], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, course_id], name: "unique_user_course", map: "unique_user_course")
  @@map("user_favorites")
}

model SavedCourse {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  courseId  Int      @map("course_id")
  savedAt   DateTime @default(now()) @map("saved_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@map("saved_courses")
}

model CoursePlace {
  id                 Int      @id @default(autoincrement())
  course_id          Int
  place_id           Int
  order_index        Int
  estimated_duration Int?
  recommended_time   String?  @db.VarChar(100)
  notes              String?
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt
  course             Course   @relation(fields: [course_id], references: [id])
  place              Place    @relation(fields: [place_id], references: [id])
  // 1. ì—­í•  ë°°ì§€ (Role Badge): ì´ ì¥ì†Œê°€ ì˜¤ëŠ˜ ë°ì´íŠ¸ì—ì„œ ë§¡ì€ ì—­í• 
  role_badge         String?  @map("role_badge") @db.VarChar(50)

  // 2. ì—ë””í„° ì½”ì¹­ (Human-in-the-loop): ë‹¨ìˆœ ì¥ì†Œ ì„¤ëª… ë§ê³  'í–‰ë™ ì§€ì¹¨'
  coaching_tip       String?  @map("coaching_tip") @db.Text

  @@map("course_places")
}

model PlaceClosedDay {
  id            Int       @id @default(autoincrement())
  place_id      Int
  day_of_week   Int?
  specific_date DateTime? @db.Date
  note          String?   @db.VarChar(200)
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  place         Place     @relation(fields: [place_id], references: [id], onDelete: Cascade)

  @@index([place_id])
  @@index([day_of_week])
  @@index([specific_date])
  @@map("place_closed_days")
}

model Highlight {
  id          Int      @id @default(autoincrement())
  course_id   Int
  title       String   @db.VarChar(255)
  description String?
  icon        String?  @db.VarChar(10)
  created_at  DateTime @default(now())
  course      Course   @relation(fields: [course_id], references: [id])

  @@map("highlights")
}

model Benefit {
  id            Int      @id @default(autoincrement())
  course_id     Int
  benefit_text  String
  category      String?  @db.VarChar(100)
  display_order Int?     @default(0)
  created_at    DateTime @default(now())
  course        Course   @relation(fields: [course_id], references: [id])

  @@map("benefits")
}

model CourseNotice {
  id            Int      @id @default(autoincrement())
  course_id     Int
  notice_text   String
  type          String?  @default("info") @db.VarChar(100)
  display_order Int?     @default(0)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  course        Course   @relation(fields: [course_id], references: [id])

  @@map("course_notices")
}

model UserStoryProgress {
  id              Int       @id @default(autoincrement())
  user_id         Int
  story_id        Int
  current_chapter Int
  status          String    @db.VarChar(30)
  started_at      DateTime?
  completed_at    DateTime?
  story           Story     @relation(fields: [story_id], references: [id])
  user            User      @relation(fields: [user_id], references: [id])

  @@unique([user_id, story_id])
  @@map("userstoryprogress")
}

model MissionSubmission {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  chapterId  Int      @map("chapter_id")
  photoUrl   String?  @map("photo_url")
  textAnswer String?  @map("text_answer")
  isCorrect  Boolean  @default(false) @map("is_correct")
  createdAt  DateTime @default(now()) @map("created_at")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("mission_submissions")
}

model UserBadge {
  id         Int      @id @default(autoincrement())
  user_id    Int
  badge_id   Int
  awarded_at DateTime @default(now())
  badge      Badge    @relation(fields: [badge_id], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, badge_id])
  @@map("user_badges")
}

model CompletedEscape {
  id          Int      @id @default(autoincrement())
  userId      Int
  storyId     Int
  completedAt DateTime @default(now())
  story       Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("CompletedEscapes")
}

model CourseTagRelation {
  // âœ¨ A, B ëŒ€ì‹  ëª…í™•í•œ ì»¬ëŸ¼ëª…(courseId, tagId) ì‚¬ìš©
  courseId  Int
  tagId     Int
  
  course    Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  tag       CourseTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([courseId, tagId]) // ë³µí•© í‚¤ ì„¤ì •
  @@index([tagId])        // íƒœê·¸ë¡œ ê²€ìƒ‰í•  ë•Œ ì†ë„ í–¥ìƒ
  @@map("course_tags_relation") // ì‹¤ì œ DB í…Œì´ë¸” ì´ë¦„
}

model GridCode {
  id          Int     @id @default(autoincrement())
  region_name String  @unique // "ì„œìš¸ ê°•ë‚¨êµ¬"ì™€ ê°™ì€ ì§€ì—­ëª…
  nx          Int
  ny          Int
}

enum ChapterType {
  intro
  restaurant
  cafe
  spot
  final_spot
  ending
}

enum MissionType {
  quiz
  photo
  gps
  puzzle
  text
  choice
}

enum RewardType {
  signup
  checkin
  ad_watch
  purchase
  event
  escape_place_clear
}

enum RewardUnit {
  coupon
}

enum SpeakerRole {
  user
  npc
  system
  clear_place
  mission_start
}

enum PlaceTheme {
  footsteps // ë°œìì·¨
  history // ì—­ì‚¬
  time // ì‹œê°„ê°„
  location // ì¥ì†Œ
}

// êµ¬ë… ë“±ê¸‰ (ë¬´ë£Œ / ë² ì´ì§ / í”„ë¦¬ë¯¸ì—„)
enum SubscriptionTier {
  FREE
  BASIC
  PREMIUM
}

// ê²°ì œ ìƒíƒœ (ëŒ€ê¸° / ì„±ê³µ / ì‹¤íŒ¨ / ì·¨ì†Œ)
enum PaymentStatus {
  READY
  PAID
  FAILED
  CANCELLED
}

// [ì¶”ê°€] ì½”ìŠ¤ ë“±ê¸‰
enum CourseGrade {
  FREE
  BASIC
  PREMIUM
}
