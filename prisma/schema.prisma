generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Payment {
  id          String        @id @default(cuid())
  userId      Int           @map("user_id")
  orderId     String        @unique @map("order_id")
  orderName   String        @map("order_name")
  amount      Int
  status      PaymentStatus @default(READY)
  paymentKey  String?       @map("payment_key")
  method      String?
  requestedAt DateTime      @default(now()) @map("requested_at")
  approvedAt  DateTime?     @map("approved_at")
  user        User          @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([orderId])
  @@map("payments")
}

model User {
  id                    Int                    @id @default(autoincrement())
  email                 String?                @unique @db.VarChar(191)
  password              String?                @db.VarChar(255)
  username              String                 @map("nickname") @db.VarChar(50)
  profileImageUrl       String?
  socialId              String?                @db.VarChar(255)
  provider              String                 @default("local") @db.VarChar(20)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  mbti                  String?                @db.VarChar(20)
  age                   Int?
  couponCount           Int                    @default(0)
  gender                String?                @db.VarChar(10)
  lastActiveAt          DateTime?
  level                 Int                    @default(1)
  location              String?                @db.VarChar(100)
  preferredTags         String[]
  ageRange              String?                @db.VarChar(20)
  birthday              DateTime?
  phone                 String?                @db.VarChar(30)
  isAutoRenewal         Boolean                @default(false) @map("is_auto_renewal")
  subscriptionExpiresAt DateTime?              @map("subscription_expires_at")
  subscriptionTier      SubscriptionTier       @default(FREE) @map("subscription_tier")
  isMarketingAgreed     Boolean                @default(false) @map("is_marketing_agreed")
  marketingAgreedAt     DateTime?              @map("marketing_agreed_at")
  hasSeenConsentModal   Boolean                @default(false) @map("has_seen_consent_modal")
  billingKey            String?                @map("billing_key") @db.VarChar(255)
  deletedAt             DateTime?              @map("deleted_at")
  appleRefreshToken     String?                @map("apple_refresh_token")
  completedCourses      CompletedCourse[]
  completedEscapes      CompletedEscape[]
  bookings              Booking[]
  unlockedCourses       CourseUnlock[]
  courses               Course[]
  locationLogs          LocationLog[]
  loginLogs             LoginLog[]
  missionSubmissions    MissionSubmission[]
  notificationInterests NotificationInterest[]
  payments              Payment[]
  pushTokens            PushToken?
  reviews               Review[]
  savedCourses          SavedCourse[]
  userBadges            UserBadge[]
  checkins              UserCheckin[]
  UserCollage           UserCollage[]
  userFavorites         UserFavorite[]
  interactions          UserInteraction[]
  userPreference        UserPreference?
  behaviorPatterns      UserBehaviorPattern[]
  rewards               UserReward[]
  userStoryProgress     UserStoryProgress[]

  @@index([provider, socialId])
  @@index([deletedAt])
  // üü¢ [Fix]: Î≥µÌï© Ïú†ÎãàÌÅ¨ Ïù∏Îç±Ïä§ Ï∂îÍ∞Ä (Ï§ëÎ≥µ Í∞ÄÏûÖ ÏõêÏ≤ú Ï∞®Îã®)
  @@unique([socialId, provider], name: "unique_social_provider")
  @@map("users")
}

model PushToken {
  id              String    @id @default(cuid())
  userId          Int       @unique
  token           String
  platform        String    @default("expo")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  subscribed      Boolean   @default(true)
  alarmDisabledAt DateTime? @map("alarm_disabled_at")
  alarmEnabledAt  DateTime? @map("alarm_enabled_at")
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_tokens")
}

model Course {
  id                   Int                 @id @default(autoincrement())
  userId               Int?
  title                String              @db.VarChar(100)
  description          String?
  imageUrl             String?             @db.VarChar(255)
  region               String?             @db.VarChar(50)
  duration             String?             @db.VarChar(45)
  concept              String?             @db.VarChar(45)
  tags                 Json?
  isPopular            Boolean             @default(false)
  rating               Float               @default(0.0)
  current_participants Int                 @default(0)
  max_participants     Int                 @default(0)
  view_count           Int                 @default(0)
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt
  sub_title            String?             @map("sub_title") @db.VarChar(100)
  target_situation     String?             @map("target_situation") @db.VarChar(50)
  is_editor_pick       Boolean             @default(false)
  grade                CourseGrade         @default(FREE)
  isPublic             Boolean             @default(true)
  completedCourses     CompletedCourse[]
  benefits             Benefit[]
  bookings             Booking[]
  courseDetail         CourseDetail?
  courseNotices        CourseNotice[]
  coursePlaces         CoursePlace[]
  courseTags           CourseTagRelation[]
  unlockedUsers        CourseUnlock[]
  user                 User?               @relation(fields: [userId], references: [id], onDelete: Cascade)
  highlights           Highlight[]
  reviews              Review[]
  savedUsers           SavedCourse[]
  userFavorites        UserFavorite[]
  interactions         UserInteraction[]

  @@index([concept])
  @@index([region])
  @@index([title])
  @@index([isPublic, grade])
  @@index([isPublic, region])
  @@map("courses")
}

model Place {
  id                   Int              @id @default(autoincrement())
  name                 String           @db.VarChar(255)
  address              String?          @db.VarChar(500)
  description          String?
  category             String?          @db.VarChar(100)
  avg_cost_range       String?          @db.VarChar(100)
  opening_hours        String?          @db.VarChar(200)
  phone                String?          @db.VarChar(50)
  website              String?          @db.VarChar(500)
  parking_available    Boolean?         @default(false)
  reservation_required Boolean?         @default(false)
  latitude             Float?
  longitude            Float?
  imageUrl             String?          @db.VarChar(500)
  created_at           DateTime         @default(now())
  updated_at           DateTime
  tags                 Json?
  reservationUrl       String?          @db.VarChar(500)
  coursePlaces         CoursePlace[]
  closed_days          PlaceClosedDay[]

  @@index([name])
  @@index([address])
  @@index([latitude, longitude])
  @@map("places")
}

model CoursePlace {
  id                 Int      @id @default(autoincrement())
  course_id          Int
  place_id           Int
  order_index        Int
  estimated_duration Int?
  recommended_time   String?  @db.VarChar(100)
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt
  coaching_tip       String?  @map("coaching_tip")
  course             Course   @relation(fields: [course_id], references: [id])
  place              Place    @relation(fields: [place_id], references: [id])

  @@map("course_places")
}

model CourseUnlock {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  courseId   Int      @map("course_id")
  unlockedAt DateTime @default(now()) @map("unlocked_at")
  course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@map("course_unlocks")
}

model NotificationInterest {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  topic     String   @db.VarChar(50)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_notification_interest_user")

  @@unique([userId, topic], map: "unique_user_topic")
  @@index([topic], map: "idx_notification_interests_topic")
  @@index([userId], map: "idx_notification_interests_user_id")
  @@map("notification_interests")
}

model Story {
  id                     Int                 @id @default(autoincrement())
  title                  String              @db.VarChar(255)
  synopsis               String?
  region                 String?             @db.VarChar(100)
  estimated_duration_min Int?
  price                  String?             @db.VarChar(100)
  reward_badge_id        Int?
  is_active              Boolean             @default(true)
  created_at             DateTime            @default(now())
  updated_at             DateTime            @updatedAt
  imageUrl               String?
  level                  Int?                @default(1)
  epilogue_text          String?
  stationName            String?             @db.VarChar(100)
  stationLat             Float?
  stationLng             Float?
  scenario               String?
  completedEscapes       CompletedEscape[]
  placeDialogues         PlaceDialogue[]
  CollageTemplate        CollageTemplate?
  reward_badge           Badge?              @relation(fields: [reward_badge_id], references: [id])
  ui                     StoryUI?
  userstoryprogress      UserStoryProgress[]

  @@map("stories")
}

model MissionSubmission {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  chapterId  Int      @map("chapter_id")
  photoUrl   String?  @map("photo_url")
  textAnswer String?  @map("text_answer")
  isCorrect  Boolean  @default(false) @map("is_correct")
  createdAt  DateTime @default(now()) @map("created_at")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("mission_submissions")
}

model UserStoryProgress {
  id              Int       @id @default(autoincrement())
  user_id         Int
  story_id        Int
  current_chapter Int
  status          String    @db.VarChar(30)
  started_at      DateTime?
  completed_at    DateTime?
  story           Story     @relation(fields: [story_id], references: [id])
  user            User      @relation(fields: [user_id], references: [id])

  @@unique([user_id, story_id])
  @@map("userstoryprogress")
}

model UserReward {
  id        Int          @id @default(autoincrement())
  amount    Int
  createdAt DateTime     @default(now())
  userId    Int
  type      RewardType
  unit      RewardUnit
  placeId   Int?
  place     PlaceOption? @relation(fields: [placeId], references: [id])
  user      User         @relation(fields: [userId], references: [id])

  @@unique([userId, placeId, type])
  @@map("user_rewards")
}

model UserCollage {
  id           Int              @id @default(autoincrement())
  userId       Int
  templateId   Int?
  collageUrl   String           @map("collage_url")
  thumbnailUrl String?          @map("thumbnail_url")
  createdAt    DateTime         @default(now()) @map("created_at")
  updatedAt    DateTime         @updatedAt @map("updated_at")
  storyId      Int?
  template     CollageTemplate? @relation(fields: [templateId], references: [id])
  user         User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_collages")
}

model LocationLog {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  purpose   String   @default("DATE_COURSE_RECOMMENDATION") @db.VarChar(100)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("location_logs")
}

model LoginLog {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  loginAt   DateTime @default(now()) @map("login_at")
  ipAddress String?  @map("ip_address") @db.VarChar(45)
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("login_logs")
}

model CourseDetail {
  id                     Int     @id @default(autoincrement())
  course_id              Int     @unique
  season                 String? @db.VarChar(50)
  course_type            String? @db.VarChar(50)
  transportation         String? @db.VarChar(50)
  recommended_start_time String? @db.VarChar(100)
  course                 Course  @relation(fields: [course_id], references: [id], onDelete: Cascade)

  @@map("course_details")
}

model CourseTag {
  id        Int                 @id @default(autoincrement())
  name      String              @unique @db.VarChar(100)
  createdAt DateTime            @default(now())
  courses   CourseTagRelation[]

  @@map("course_tags")
}

model StoryUI {
  id          Int      @id @default(autoincrement())
  storyId     Int      @unique
  engine_key  String   @db.VarChar(50)
  tokens_json Json?
  flow_json   Json?
  version     Int      @default(1)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  story       Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)

  @@index([engine_key])
  @@map("story_ui")
}

model PlaceOption {
  id             Int             @id @default(autoincrement())
  storyId        Int
  name           String
  address        String?
  latitude       Float?
  longitude      Float?
  description    String?
  imageUrl       String?
  category       String?
  signature      String?
  theme          PlaceTheme?
  placeDialogues PlaceDialogue[]
  missions       PlaceMission[]
  stories        PlaceStory[]
  userRewards    UserReward[]
}

model PlaceDialogue {
  id          Int          @id @default(autoincrement())
  storyId     Int
  placeId     Int?
  order       Int          @default(1)
  type        String       @default("main")
  speaker     String?
  message     String
  imageUrl    String?
  createdAt   DateTime     @default(now())
  isLetter    Boolean      @default(false)
  letterIndex Int?
  role        SpeakerRole  @default(npc)
  place       PlaceOption? @relation(fields: [placeId], references: [id])
  story       Story        @relation(fields: [storyId], references: [id])
}

model PlaceMission {
  id             Int          @id @default(autoincrement())
  placeId        Int
  missionNumber  Int
  missionPayload Json?
  description    String?
  answer         String?
  hint           String?
  question       String?
  missionType    MissionType
  place          PlaceOption  @relation(fields: [placeId], references: [id])
  placeStories   PlaceStory[]
}

model PlaceStory {
  id          Int           @id @default(autoincrement())
  placeId     Int
  order       Int
  speaker     String?
  dialogue    String?
  narration   String?
  nextTrigger String?
  missionId   Int?
  mission     PlaceMission? @relation(fields: [missionId], references: [id])
  place       PlaceOption   @relation(fields: [placeId], references: [id])
}

model CollageTemplate {
  id          Int           @id @default(autoincrement())
  name        String        @db.VarChar(50)
  imageUrl    String?       @map("image_url")
  framesJson  Json?         @map("frames_json")
  isPublic    Boolean       @default(true) @map("is_public")
  createdAt   DateTime      @default(now()) @map("created_at")
  storyId     Int?          @unique
  story       Story?        @relation(fields: [storyId], references: [id], onDelete: Cascade)
  userCollage UserCollage[]

  @@map("collage_templates")
}

model Badge {
  id          Int         @id @default(autoincrement())
  name        String      @unique @db.VarChar(100)
  description String?
  image_url   String?     @db.VarChar(500)
  stories     Story[]
  userBadges  UserBadge[]

  @@map("badges")
}

model CompletedCourse {
  id          Int      @id @default(autoincrement())
  userId      Int
  courseId    Int
  completedAt DateTime @default(now())
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("CompletedCourses")
}

model Review {
  id        Int      @id @default(autoincrement())
  userId    Int
  courseId  Int
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  imageUrls String[] @default([])
  isPublic  Boolean  @default(true) @map("is_public")
  tags      String[] @default([]) // üü¢ ÌÉúÍ∑∏ ÌïÑÎìú Ï∂îÍ∞Ä
  placeData Json?    @map("place_data") // üü¢ Ïû•ÏÜåÎ≥Ñ Îç∞Ïù¥ÌÑ∞: { [stepIndex]: { photos: string[], tags: string[] } }
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("reviews")
}

model Booking {
  id           Int      @id @default(autoincrement())
  user_id      Int
  course_title String   @db.VarChar(255)
  booking_date DateTime @db.Date
  status       String   @db.VarChar(45)
  price        String   @db.VarChar(50)
  participants Int
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  course_id    Int
  course       Course   @relation(fields: [course_id], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("bookings")
}

model UserFavorite {
  id         Int      @id @default(autoincrement())
  user_id    Int
  course_id  Int
  created_at DateTime @default(now())
  course     Course   @relation(fields: [course_id], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, course_id], name: "unique_user_course", map: "unique_user_course")
  @@map("user_favorites")
}

model SavedCourse {
  id       Int      @id @default(autoincrement())
  userId   Int      @map("user_id")
  courseId Int      @map("course_id")
  savedAt  DateTime @default(now()) @map("saved_at")
  course   Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@map("saved_courses")
}

model PlaceClosedDay {
  id            Int       @id @default(autoincrement())
  place_id      Int
  day_of_week   Int?
  specific_date DateTime? @db.Date
  note          String?   @db.VarChar(200)
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt
  place         Place     @relation(fields: [place_id], references: [id], onDelete: Cascade)

  @@index([place_id])
  @@index([day_of_week])
  @@index([specific_date])
  @@map("place_closed_days")
}

model Highlight {
  id          Int      @id @default(autoincrement())
  course_id   Int
  title       String   @db.VarChar(255)
  description String?
  icon        String?  @db.VarChar(10)
  created_at  DateTime @default(now())
  course      Course   @relation(fields: [course_id], references: [id])

  @@map("highlights")
}

model Benefit {
  id            Int      @id @default(autoincrement())
  course_id     Int
  benefit_text  String
  category      String?  @db.VarChar(100)
  display_order Int?     @default(0)
  created_at    DateTime @default(now())
  course        Course   @relation(fields: [course_id], references: [id])

  @@map("benefits")
}

model CourseNotice {
  id            Int      @id @default(autoincrement())
  course_id     Int
  notice_text   String
  type          String?  @default("info") @db.VarChar(100)
  display_order Int?     @default(0)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  course        Course   @relation(fields: [course_id], references: [id])

  @@map("course_notices")
}

model UserCheckin {
  id        Int      @id @default(autoincrement())
  date      DateTime
  rewarded  Boolean  @default(false)
  createdAt DateTime @default(now())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])

  @@map("user_checkins")
}

model UserInteraction {
  id        Int      @id @default(autoincrement())
  userId    Int
  courseId  Int
  action    String
  createdAt DateTime @default(now())
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_interactions")
}

model UserPreference {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique @map("user_id")
  preferences Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

model UserBehaviorPattern {
  id             Int      @id @default(autoincrement())
  userId         Int      @map("user_id")
  conceptPattern Json     @map("concept_pattern") // { "ÌûêÎßÅ": 8, "ÌôúÎèôÏ†ÅÏù∏": 3, ... }
  regionPattern  Json     @map("region_pattern") // { "ÏÑúÏö∏ Í∞ïÎÇ®Íµ¨": 10, "Ï†úÏ£º": 2, ... }
  moodPattern    Json     @map("mood_pattern") // { "Î°úÎß®Ìã±Ìïú": 6, "ÌôúÍ∏∞Ï∞¨": 4, ... }
  goalPattern    Json     @map("goal_pattern") // { "Îç∞Ïù¥Ìä∏": 12, "ÌòºÏûêÎßåÏùòÏãúÍ∞Ñ": 3, ... }
  snapshotDate   DateTime @default(now()) @map("snapshot_date")
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, snapshotDate])
  @@map("user_behavior_patterns")
}

model UserBadge {
  id         Int      @id @default(autoincrement())
  user_id    Int
  badge_id   Int
  awarded_at DateTime @default(now())
  badge      Badge    @relation(fields: [badge_id], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, badge_id])
  @@map("user_badges")
}

model CompletedEscape {
  id          Int      @id @default(autoincrement())
  userId      Int
  storyId     Int
  completedAt DateTime @default(now())
  story       Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("CompletedEscapes")
}

model CourseTagRelation {
  courseId Int
  tagId    Int
  course   Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  tag      CourseTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([courseId, tagId])
  @@index([tagId])
  @@map("course_tags_relation")
}

model GridCode {
  id          Int    @id @default(autoincrement())
  region_name String @unique
  nx          Int
  ny          Int
}

enum ChapterType {
  intro
  restaurant
  cafe
  spot
  final_spot
  ending
}

enum MissionType {
  quiz
  photo
  gps
  puzzle
  text
  choice
}

enum RewardType {
  signup
  checkin
  ad_watch
  purchase
  event
  escape_place_clear
  course_completion_milestone
  personal_memory_milestone
}

enum RewardUnit {
  coupon
}

enum SpeakerRole {
  user
  npc
  system
  mission_start
  clear_place
}

enum PlaceTheme {
  footsteps
  history
  time
  location
}

enum SubscriptionTier {
  FREE
  BASIC
  PREMIUM
}

enum PaymentStatus {
  READY
  PAID
  FAILED
  CANCELLED
}

enum CourseGrade {
  FREE
  BASIC
  PREMIUM
}
